# 开发/生产模式 - 快速开始

## ✨ 功能特性

✅ **开发模式**：使用 Mock 数据，前端独立开发  
✅ **生产模式**：连接真实 FastAPI 后端  
✅ **一键切换**：UI 界面轻松切换，无需改代码  
✅ **自动路由**：API 调用自动选择数据源  
✅ **类型安全**：完整的 TypeScript 类型支持  
✅ **数据映射**：自动转换 snake_case ↔ camelCase  

---

## 🎯 使用场景

### 场景 1：前端独立开发
**状态**：后端还未就绪，前端需要先开始开发  
**方案**：使用开发模式（默认），所有数据自动 Mock

### 场景 2：前后端联调
**状态**：后端 API 已完成，需要集成测试  
**方案**：切换到生产模式，测试真实数据流

### 场景 3：功能演示
**状态**：需要演示 UI 但后端不可用  
**方案**：使用开发模式，Mock 数据足够完整

### 场景 4：生产环境调试
**状态**：生产环境遇到问题，需要对比 Mock 数据  
**方案**：临时切换到开发模式排查问题

---

## 🚀 快速开始

### 步骤 1：查看当前模式

打开应用 → 点击设置图标（⚙️）→ 查看「API 模式配置」面板

### 步骤 2：切换模式

点击「开发模式」或「生产模式」按钮 → 确认刷新

### 步骤 3：验证

- **开发模式**：看到"使用模拟数据"提示
- **生产模式**：看到"连接真实后端"提示

---

## 📁 新增文件说明

| 文件 | 作用 | 何时修改 |
|-----|------|---------|
| `src/config/env.ts` | 环境配置管理 | 几乎不需要修改 |
| `src/api/types.ts` | 数据类型定义 | 后端接口变更时 |
| `src/api/mock.ts` | Mock 数据生成 | 需要更真实的测试数据时 |
| `src/api/client.ts` | API 调用封装 | 添加新接口时 |
| `components/ModeSwitch.tsx` | 模式切换 UI | 需要调整 UI 时 |

---

## 💡 最佳实践

### ✅ 推荐做法

1. **开发初期**：使用开发模式快速迭代 UI
2. **API 就绪后**：切换到生产模式进行集成测试
3. **部署前**：两种模式都要测试，确保兼容
4. **遇到问题**：切换模式对比，快速定位是前端还是后端问题

### ❌ 避免做法

1. ~~不要直接在组件中写 `fetch('/api/...')`~~
2. ~~不要硬编码 Mock 数据到组件中~~
3. ~~不要绕过 `client.ts` 直接调用 API~~
4. ~~不要在生产模式下假设数据一定成功返回（要处理错误）~~

---

## 🔧 给后端开发者

### 你需要做什么？

1. **实现接口**：参考 `guidelines/Guidelines.md`
2. **遵循格式**：按照 `src/api/types.ts` 返回数据
3. **测试对接**：前端切换到生产模式，验证数据正确性

### 接口清单

- [ ] `GET /api/steels?limit=20` - 钢板列表
- [ ] `GET /api/defects/{seq_no}` - 缺陷列表
- [ ] `GET /api/images/frame?surface=...&seq_no=...&image_index=...` - 图像
- [ ] `GET /health` - 健康检查

详细规范见：`API_INTEGRATION_GUIDE.md`

---

## 🔍 常见问题

### Q: 如何知道当前是什么模式？

A: 三种方法：
1. 设置界面查看「API 模式配置」
2. 浏览器控制台：`localStorage.getItem('app_mode')`
3. 系统诊断对话框会显示当前模式

### Q: 切换模式后需要重启应用吗？

A: 需要刷新页面。系统会自动提示，点击确认即可。

### Q: Mock 数据是否会保存？

A: 不会。Mock 数据每次刷新都重新生成，不连接数据库。

### Q: 生产模式下 API 调用失败怎么办？

A: 
1. 检查后端是否运行
2. 查看浏览器 Network 面板的错误信息
3. 切换回开发模式继续工作
4. 联系后端开发者解决问题

### Q: 如何添加新的 API？

A:
1. 在 `src/api/types.ts` 定义类型
2. 在 `src/api/mock.ts` 添加 Mock 函数
3. 在 `src/api/client.ts` 添加客户端函数
4. 在组件中使用新函数

### Q: 数据格式不匹配怎么办？

A: 
1. 对比后端返回的 JSON 和 `types.ts` 的定义
2. 检查是否使用了映射函数 `mapSteelItem` / `mapDefectItem`
3. 必要时调整映射函数

---

## 📊 架构图

```
┌─────────────┐
│   组件层    │ ← 直接使用 camelCase 数据
│  (React)    │
└──────┬──────┘
       │
       ↓
┌─────────────┐
│  API Client │ ← 统一的调用接口
│ (client.ts) │   listSteels(), getDefects()...
└──────┬──────┘
       │
       ├──────────────┬──────────────┐
       ↓              ↓              ↓
┌─────────┐    ┌──────────┐   ┌─────────┐
│  Mock   │    │  真实API │   │ 映射层  │
│ (dev)   │    │  (prod)  │   │ (types) │
└─────────┘    └──────────┘   └─────────┘
                      │
                      ↓
              ┌──────────────┐
              │ FastAPI 后端 │
              │   数据库      │
              └──────────────┘
```

---

## 🎨 UI 位置

**路径**：主界面 → 右上角设置图标 → 系统配置

**截图位置**：在「SYSTEM CONFIGURATION」页面顶部

---

## 📚 相关文档

- **API 集成详细指南**：`API_INTEGRATION_GUIDE.md`
- **后端接口规范**：`guidelines/Guidelines.md`
- **类型定义参考**：`src/api/types.ts`

---

## 🎉 总结

这套方案让前后端可以**并行开发，互不阻塞**：

- 前端：先用 Mock 数据完成 UI 和交互
- 后端：按规范实现 API，不用等前端
- 集成：一键切换，立即验证

**祝开发顺利！**

---

*最后更新：2024-12-03*
